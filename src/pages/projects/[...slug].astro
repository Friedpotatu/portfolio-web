---
import { getCollection, getEntry, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';
import Gallery from '../../components/Gallery.astro';
import GitHub from '../../components/icons/GitHub.astro';
import Star from '../../components/icons/Star.astro';
import ThemeToggle from '../../components/ThemeToggle.astro';
import { getTechColor } from '../../utils/techColors';

export async function getStaticPaths() {
    const projects = await getCollection('projects');
    return projects.map((project) => ({
        params: { slug: project.id },
        props: { project }
    }));
}

const { project } = Astro.props;

// Obtener la entrada específica y renderizarla
const entry = await getEntry('projects', project.id);
if (!entry) {
    throw new Error(`No se pudo encontrar el proyecto: ${project.id}`);
}
const { Content, headings } = await render(entry);
---

<Layout
    title={`${project.data.title} - Portafolio Nicolás Pavez`}
    description={project.data.description}
    image={project.data.image}
    type="article"
>
    <ThemeToggle />
    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-5xl mx-auto">
            <!-- Botón de regreso -->
            <button
                id="back-btn"
                class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors mb-8 cursor-pointer"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Volver
            </button>

            <!-- Hero del proyecto -->
            <div class="mb-12">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-3">{project.data.title}</h1>
                        <p class="text-lg text-gray-600 dark:text-gray-400">{project.data.description}</p>
                    </div>
                    {project.data.featured && (
                        <div class="p-2 bg-white/90 dark:bg-neutral-800/90 backdrop-blur-sm rounded-full shadow-md">
                            <Star class="w-5 h-5 text-blue-600 dark:text-blue-400" />
                        </div>
                    )}
                </div>

                <!-- Tecnologías -->
                <div class="flex flex-wrap gap-2 mb-6">
                    {project.data.technologies.map((tech) => (
                        <span class={`px-3 py-1 rounded-full text-xs font-medium ${getTechColor(tech)}`}>
                            {tech}
                        </span>
                    ))}
                </div>

                <!-- Botones de acción -->
                <div class="flex flex-wrap gap-3">
                    {project.data.demo && (
                        <a
                            href={project.data.demo}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
                        >
                            Ver Demo
                        </a>
                    )}

                    {project.data.github ? (
                        <a
                            href={project.data.github}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="flex items-center gap-x-2 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:border-blue-600 hover:text-blue-600 dark:hover:border-blue-400 dark:hover:text-blue-400 rounded-lg text-sm font-medium transition-colors"
                        >
                            <GitHub class="w-4 h-4" />
                            Código
                        </a>
                    ) : (
                        <button
                            disabled
                            class="flex items-center gap-x-2 px-4 py-2 border border-gray-200 dark:border-gray-700 text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-800 rounded-lg text-sm font-medium cursor-not-allowed opacity-60"
                        >
                            <GitHub class="w-4 h-4" />
                            Privado
                        </button>
                    )}
                </div>
            </div>

            <!-- Imagen principal -->
            <div class="rounded-2xl overflow-hidden mb-12 shadow-lg">
                {project.data.image.endsWith('.mkv') || project.data.image.endsWith('.mp4') || project.data.image.endsWith('.webm') ? (
                    <video
                        src={project.data.image}
                        width="1200"
                        height="675"
                        autoplay
                        muted
                        loop
                        playsinline
                        class="w-full aspect-video object-cover"
                    />
                ) : (
                    <Image
                        src={project.data.image}
                        alt={project.data.title}
                        loading="eager"
                        class="w-full aspect-video object-cover"
                        width={1200}
                        height={675}
                    />
                )}
            </div>

            <!-- Contenido del proyecto -->
            <div class="mb-12">
                <div class="prose prose-lg dark:prose-invert max-w-none prose-headings:text-gray-900 dark:prose-headings:text-white prose-p:text-gray-600 dark:prose-p:text-gray-300 prose-a:text-blue-600 dark:prose-a:text-blue-400">
                    <Content />
                </div>
            </div>

            <!-- Galería de imágenes -->
            {project.data.gallery && project.data.galleryImages && project.data.galleryImages.length > 0 && (
                <div>
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-6">Galería</h2>
                    <Gallery
                        images={project.data.galleryImages}
                        projectTitle={project.data.title}
                    />
                </div>
            )}
        </div>
    </div>

    <script>
        // Manejar navegación del botón "Volver a Proyectos"
        let backBtnHandler = null;

        document.addEventListener('astro:page-load', () => {
            const backBtn = document.getElementById('back-btn');

            // Limpiar handler anterior si existe
            if (backBtnHandler && backBtn) {
                backBtn.removeEventListener('click', backBtnHandler);
            }

            // Crear nuevo handler
            backBtnHandler = async () => {
                const { navigate } = await import("astro:transitions/client");
                navigate('/#projects');
            };

            backBtn?.addEventListener('click', backBtnHandler);
        });

        // Limpiar antes de navegar (evitar memory leaks)
        document.addEventListener('astro:before-preparation', () => {
            const backBtn = document.getElementById('back-btn');
            if (backBtn && backBtnHandler) {
                backBtn.removeEventListener('click', backBtnHandler);
                backBtnHandler = null;
            }
        }, { once: true });
    </script>
</Layout>