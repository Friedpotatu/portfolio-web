---
import { getCollection, render } from 'astro:content';
import { getTechColor } from '../utils/techColors';

// Obtener todas las experiencias y ordenarlas
const experiences = await getCollection('experience');
const sortedExperiences = experiences.sort((a, b) => a.data.order - b.data.order);

// Renderizar el contenido de cada experiencia
const renderedExperiences = await Promise.all(
    sortedExperiences.map(async (experience) => {
        const { Content } = await render(experience);
        return {
            ...experience,
            Content
        };
    })
);

// Función para formatear fechas
function formatDate(dateString: string): string {
    const months = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    
    const [year, month] = dateString.split('-');
    return `${months[parseInt(month) - 1]} ${year}`;
}

// Función para crear el rango de fechas
function getDateRange(startDate: string, endDate?: string, current?: boolean): string {
    const start = formatDate(startDate);
    
    if (current) {
        return `${start} - Presente`;
    }
    
    if (endDate) {
        const end = formatDate(endDate);
        return `${start} - ${end}`;
    }
    
    return start;
}
---

<div class="max-w-5xl mx-auto">
    <h2 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-16">
        Experiencia Laboral
    </h2>

    <div class="relative">
        {/* Línea de tiempo vertical */}
        <div class="absolute left-0 md:left-8 top-0 bottom-0 w-0.5 bg-gradient-to-b from-blue-500 via-blue-400 to-transparent"></div>

        <div class="space-y-12">
            {renderedExperiences.map((experience, index) => (
                <div class="relative pl-8 md:pl-20">
                    {/* Punto en la timeline */}
                    <div class="absolute left-0 md:left-8 -translate-x-1/2 top-2">
                        <div class="w-4 h-4 bg-blue-600 dark:bg-blue-500 rounded-full ring-4 ring-white dark:ring-gray-900 shadow-md"></div>
                    </div>

                    {/* Contenido de la experiencia */}
                    <div class="group">
                        {/* Header */}
                        <div class="mb-4">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-2 mb-2">
                                <div>
                                    <h3 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-1">
                                        {experience.data.title}
                                    </h3>
                                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4">
                                        <p class="text-lg font-medium text-blue-600 dark:text-blue-400">
                                            {experience.data.company}
                                        </p>
                                        {experience.data.location && (
                                            <>
                                                <span class="hidden md:inline text-gray-400">•</span>
                                                <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                    </svg>
                                                    {experience.data.location}
                                                </p>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full text-sm font-medium">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        {getDateRange(experience.data.startDate, experience.data.endDate, experience.data.current)}
                                    </span>
                                    {experience.data.current && (
                                        <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-full text-xs font-semibold">
                                            Actual
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Descripción principal */}
                            {experience.Content && (
                                <div class="text-gray-600 dark:text-gray-400 leading-relaxed prose prose-sm dark:prose-invert max-w-none mb-4">
                                    <experience.Content />
                                </div>
                            )}
                        </div>

                        {/* Timeline de roles */}
                        {experience.data.roles && experience.data.roles.length > 0 && (
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                    </svg>
                                    Evolución profesional
                                </h4>
                                <div class="relative space-y-3">
                                    {/* Mini timeline line */}
                                    <div class="absolute left-3 top-3 bottom-3 w-0.5 bg-gradient-to-b from-blue-400 via-blue-300 to-blue-200 dark:from-blue-600 dark:via-blue-700 dark:to-blue-800"></div>

                                    {experience.data.roles.map((role, roleIndex) => (
                                        <div class="relative pl-10 group/role">
                                            {/* Timeline dot */}
                                            <div class="absolute left-0 top-3">
                                                <div class="w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center ring-2 ring-blue-500 dark:ring-blue-600 shadow-sm group-hover/role:shadow-md transition-shadow">
                                                    <div class="w-2 h-2 bg-blue-600 dark:bg-blue-400 rounded-full"></div>
                                                </div>
                                            </div>

                                            {/* Role card */}
                                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-600 transition-colors shadow-sm hover:shadow-md">
                                                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
                                                    <h5 class="font-semibold text-gray-900 dark:text-white text-base">
                                                        {role.title}
                                                    </h5>
                                                    <div class="flex items-center gap-1.5 text-xs text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 px-2.5 py-1 rounded-full whitespace-nowrap">
                                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                        {getDateRange(role.startDate, role.endDate, role.current)}
                                                    </div>
                                                </div>
                                                {role.highlights && role.highlights.length > 0 && (
                                                    <ul class="space-y-1.5 text-sm text-gray-600 dark:text-gray-400">
                                                        {role.highlights.map((highlight) => (
                                                            <li class="flex items-start gap-2.5 leading-relaxed">
                                                                <svg class="w-4 h-4 text-blue-500 dark:text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                                </svg>
                                                                <span>{highlight}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Aspectos destacados */}
                        {experience.data.highlights && experience.data.highlights.length > 0 && (
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Logros destacados
                                </h4>
                                <ul class="space-y-2 text-gray-600 dark:text-gray-400">
                                    {experience.data.highlights.map((highlight) => (
                                        <li class="flex items-start gap-2">
                                            <span class="text-blue-500 mt-1.5">✓</span>
                                            <span>{highlight}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {/* Tecnologías */}
                        <div>
                            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                Tecnologías utilizadas
                            </h4>
                            <div class="flex flex-wrap gap-2">
                                {experience.data.technologies.map((tech) => (
                                    <span class={`px-3 py-1 rounded-full text-xs font-medium ${getTechColor(tech)}`}>
                                        {tech}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    </div>
</div>