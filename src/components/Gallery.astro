---
// src/components/Gallery.astro
import { Image } from 'astro:assets';

interface Props {
    images: Array<{
        src: string;
        alt: string;
        caption?: string;
    }>;
    projectTitle: string;
}

const { images, projectTitle } = Astro.props;

// Generar un ID único para este componente de galería
const galleryId = projectTitle.toLowerCase().replace(/[^a-z0-9]/g, '-');
---

<div class="gallery-container max-w-6xl mx-auto p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {images.map((image, index) => (
            <div 
                class="gallery-item cursor-pointer group"
                data-gallery-id={galleryId}
                data-index={index}
            >
                <div class="relative overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800 aspect-video">
                    {image.src.endsWith('.mkv') || image.src.endsWith('.mp4') || image.src.endsWith('.webm') ? (
                        <video
                            src={image.src}
                            muted
                            loop
                            playsinline
                            preload="metadata"
                            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                        />
                    ) : (
                        <Image
                            src={image.src}
                            alt={image.alt}
                            loading="lazy"
                            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                            width={400}
                            height={300}
                        />
                    )}
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-300"></div>

                    <!-- Icono indicador de tipo de media -->
                    <div class="absolute top-2 right-2 bg-black/60 rounded-full p-1.5">
                        {image.src.endsWith('.mkv') || image.src.endsWith('.mp4') || image.src.endsWith('.webm') ? (
                            <!-- Icono de video -->
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        ) : (
                            <!-- Icono de imagen -->
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21,15 16,10 5,21"></polyline>
                            </svg>
                        )}
                    </div>
                </div>
                {image.caption && (
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400 text-center">
                        {image.caption}
                    </p>
                )}
            </div>
        ))}
    </div>
</div>

<!-- Modal para vista ampliada -->
<div id={`gallery-modal-${galleryId}`} class="fixed inset-0 bg-black/90 z-50 hidden">
    <div class="absolute inset-0 flex flex-col">
        <!-- Header con botón cerrar -->
        <div class="flex justify-end p-4 z-10">
            <button 
                id={`close-modal-${galleryId}`}
                class="text-white hover:text-gray-300 transition-colors bg-black/50 rounded-full p-2"
                aria-label="Cerrar galería"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Contenedor principal de imagen/video (renderizado dinámico) -->
        <div class="flex-1 flex items-center justify-center px-4 pb-20 min-h-0">
            <div id={`modal-content-${galleryId}`} class="relative w-full h-full flex items-center justify-center">
                <!-- El contenido se renderiza dinámicamente aquí -->
            </div>
        </div>
        
        <!-- Navegación -->
        <button 
            id={`prev-btn-${galleryId}`}
            class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-3 rounded-full transition-colors"
            aria-label="Imagen anterior"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        
        <button 
            id={`next-btn-${galleryId}`}
            class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-3 rounded-full transition-colors"
            aria-label="Siguiente imagen"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
        
        <!-- Caption y contador -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-center bg-black/50 rounded-lg px-4 py-2">
            <p id={`modal-caption-${galleryId}`} class="text-white text-sm mb-1"></p>
            <p class="text-gray-300 text-xs">
                <span id={`current-index-${galleryId}`}>1</span> de <span id={`total-images-${galleryId}`}>{images.length}</span>
            </p>
        </div>
    </div>
</div>

<script define:vars={{ images, projectTitle }}>
    // Variables globales para limpieza
    let galleryCleanup = null;

    function initializeGallery() {
        let currentIndex = 0;
        let currentMediaElement = null; // Elemento actual renderizado
        const preloadCache = new Map(); // Cache para preload

        // Generar ID único para esta instancia
        const galleryId = projectTitle.toLowerCase().replace(/[^a-z0-9]/g, '-');

        // Elementos del DOM
        const modal = document.getElementById(`gallery-modal-${galleryId}`);
        const modalContent = document.getElementById(`modal-content-${galleryId}`);
        const modalCaption = document.getElementById(`modal-caption-${galleryId}`);
        const currentIndexEl = document.getElementById(`current-index-${galleryId}`);
        const closeBtn = document.getElementById(`close-modal-${galleryId}`);
        const prevBtn = document.getElementById(`prev-btn-${galleryId}`);
        const nextBtn = document.getElementById(`next-btn-${galleryId}`);
        const galleryItems = document.querySelectorAll(`[data-gallery-id="${galleryId}"]`);

        if (!modal || !modalContent || !modalCaption || !currentIndexEl) {
            return;
        }

        // Detectar si es video
        function isVideo(src) {
            return src && (src.endsWith('.mkv') || src.endsWith('.mp4') || src.endsWith('.webm'));
        }

        // Renderizar media dinámicamente
        function renderMedia(index) {
            const item = images[index];
            if (!item) return null;

            let element;

            if (isVideo(item.src)) {
                // Crear elemento video
                element = document.createElement('video');
                element.src = item.src;
                element.controls = true;
                element.autoplay = true;
                element.muted = true;
                element.loop = true;
                element.className = 'max-w-full max-h-full object-contain rounded-lg shadow-2xl';
            } else {
                // Crear elemento img
                element = document.createElement('img');
                element.src = item.src;
                element.alt = item.alt;
                element.className = 'max-w-full max-h-full object-contain rounded-lg shadow-2xl';
            }

            return element;
        }

        // Precargar imagen/video adyacente
        function preloadAdjacent(index) {
            // Precargar siguiente
            const nextIndex = (index + 1) % images.length;
            if (!preloadCache.has(nextIndex) && images[nextIndex]) {
                const nextItem = images[nextIndex];
                if (isVideo(nextItem.src)) {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.src = nextItem.src;
                    preloadCache.set(nextIndex, video);
                } else {
                    const img = new Image();
                    img.src = nextItem.src;
                    preloadCache.set(nextIndex, img);
                }
            }

            // Precargar anterior
            const prevIndex = (index - 1 + images.length) % images.length;
            if (!preloadCache.has(prevIndex) && images[prevIndex]) {
                const prevItem = images[prevIndex];
                if (isVideo(prevItem.src)) {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.src = prevItem.src;
                    preloadCache.set(prevIndex, video);
                } else {
                    const img = new Image();
                    img.src = prevItem.src;
                    preloadCache.set(prevIndex, img);
                }
            }
        }

        // Actualizar contenido del modal
        function updateModalContent() {
            if (!images || images.length === 0) return;

            const item = images[currentIndex];
            if (!item) return;

            // Pausar y limpiar elemento anterior
            if (currentMediaElement) {
                if (currentMediaElement.tagName === 'VIDEO') {
                    currentMediaElement.pause();
                }
                currentMediaElement.remove();
                currentMediaElement = null;
            }

            // Renderizar nuevo elemento
            currentMediaElement = renderMedia(currentIndex);
            if (currentMediaElement) {
                modalContent.appendChild(currentMediaElement);
            }

            // Actualizar caption y contador
            modalCaption.textContent = item.caption || '';
            currentIndexEl.textContent = (currentIndex + 1).toString();

            // Precargar imágenes adyacentes
            preloadAdjacent(currentIndex);
        }

        // Abrir modal
        function openModal(index) {
            currentIndex = index;
            updateModalContent();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';

            // Mostrar/ocultar botones de navegación
            if (images.length <= 1) {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            } else {
                if (prevBtn) prevBtn.style.display = 'block';
                if (nextBtn) nextBtn.style.display = 'block';
            }
        }

        // Cerrar modal
        function closeModal() {
            // Pausar y limpiar elemento actual
            if (currentMediaElement) {
                if (currentMediaElement.tagName === 'VIDEO') {
                    currentMediaElement.pause();
                    currentMediaElement.currentTime = 0;
                }
                currentMediaElement.remove();
                currentMediaElement = null;
            }

            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
        }

        // Navegar a siguiente
        function nextImage() {
            if (images.length <= 1) return;
            currentIndex = (currentIndex + 1) % images.length;
            updateModalContent();
        }

        // Navegar a anterior
        function prevImage() {
            if (images.length <= 1) return;
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            updateModalContent();
        }

        // Event handlers
        const itemHandlers = [];
        const modalClickHandler = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };

        const keydownHandler = (e) => {
            if (modal && !modal.classList.contains('hidden')) {
                switch (e.key) {
                    case 'Escape':
                        closeModal();
                        break;
                    case 'ArrowLeft':
                        prevImage();
                        break;
                    case 'ArrowRight':
                        nextImage();
                        break;
                }
            }
        };

        // Agregar event listeners
        if (galleryItems) {
            galleryItems.forEach((item, index) => {
                if (item) {
                    const handler = () => openModal(index);
                    item.addEventListener('click', handler);
                    itemHandlers.push({ element: item, handler });
                }
            });
        }

        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (nextBtn) nextBtn.addEventListener('click', nextImage);
        if (prevBtn) prevBtn.addEventListener('click', prevImage);
        if (modal) modal.addEventListener('click', modalClickHandler);
        document.addEventListener('keydown', keydownHandler);

        // Función de limpieza
        galleryCleanup = () => {
            // Remover event listeners
            itemHandlers.forEach(({ element, handler }) => {
                element.removeEventListener('click', handler);
            });
            if (closeBtn) closeBtn.removeEventListener('click', closeModal);
            if (nextBtn) nextBtn.removeEventListener('click', nextImage);
            if (prevBtn) prevBtn.removeEventListener('click', prevImage);
            if (modal) modal.removeEventListener('click', modalClickHandler);
            document.removeEventListener('keydown', keydownHandler);

            // Limpiar elemento actual
            if (currentMediaElement) {
                if (currentMediaElement.tagName === 'VIDEO') {
                    currentMediaElement.pause();
                }
                currentMediaElement.remove();
                currentMediaElement = null;
            }

            // Limpiar cache de preload
            preloadCache.clear();

            // Cerrar modal si está abierto
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }
        };
    }

    // Inicializar cuando la página se carga
    document.addEventListener('astro:page-load', () => {
        if (galleryCleanup) {
            galleryCleanup();
            galleryCleanup = null;
        }
        initializeGallery();
    });

    // Limpiar antes de navegar (evitar memory leaks)
    document.addEventListener('astro:before-preparation', () => {
        if (galleryCleanup) {
            galleryCleanup();
            galleryCleanup = null;
        }
    }, { once: true });

    // Inicializar inmediatamente si el DOM ya está listo
    if (document.readyState !== 'loading') {
        initializeGallery();
    } else {
        document.addEventListener('DOMContentLoaded', initializeGallery);
    }
</script>